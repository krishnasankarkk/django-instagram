{% extends "base.html" %}
{% load static %}
{% block title %}
    <title>Profile</title>
{% endblock title %}
{% block main_content %}
    <link rel="stylesheet" href="{% static '/users/css/profile.css' %}">
    <div class='profile-section'>
        
        <div class='profile-content'>
            <div class='profile-pic'>
                {% if account_details %}
                <img class="profile-pic" src="/media/{{account_details.profile_pic}}" alt="img">
                <div class="full-name-section">
                    <div id="fullname">
                        <h1>{{account_details.full_name}}</h1>
                    </div>
                    <div id="full-name-input-section">
                        <input id="fullname-input" type="text">
                        <span id="fullname-input-save" class="material-symbols-outlined">
                            task_alt
                        </span>
                    </div>
                </div>
                <div class="followers-section">
                    <div class="post-count">
                        <b>{{account_details.posts}}</b>
                        <span>Posts</span>
                    </div>
                    <div class="followers">
                        <b>{{followers}}</b>
                        <span>Followers</span>
                    </div>
                    <div class="following">
                        <b>{{following}}</b>
                        <span>Following</span>
                    </div>
                </div>
                <div class='about-section'>
                    <h2>About</h2>
                    <span>{{account_details.bio}}</span>
                </div>
                {% endif %}
            </div>
            <div class='profile-post-section'>
                <div class="create-post-section">
                    <span class='create-post-button' id='create-post-button'>Create post<i class="fa fa-plus" aria-hidden="true"></i></span>
                    <div class="create-post-popup" id="create-post-popup">
                        <form id="form" action="{% url 'posts:create-post' %}" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <span id="close-button"><i class="fa fa-times" aria-hidden="true"></i></span>
                            <h2>Create new post</h2>
                            <div class="image-section">
                                <span id="clear-image-button"><i class="fa fa-times" aria-hidden="true"></i></span>
                                <img id="uploaded-image" src="" alt="">
                            </div>
                            <div id="upload-button">
                                <input type="file" id="upload-input" name="uploaded_image" value="">
                                <label for="upload-input" class='upload-button'>Upload image<i class="fa fa-arrow-up" aria-hidden="true"></i></label>
                            </div>
                            <div class="post-caption">
                                <h3>Write caption</h3>
                                <textarea class="caption" type="text" name="caption" id="caption" placeholder="Write caption..."></textarea>
                            </div>
                            <div>
                                <span id="post-button">Post<i class="fa fa-upload" aria-hidden="true"></i></span>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="posts">
                    {% if posts %}
                        {% for post in posts %}
                            <img class="post" src="/media/{{post.post_img}}" alt="post">
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <script>
        const createPostPopup = document.getElementById("create-post-popup");
        const createPostButton = document.getElementById("create-post-button");
        const popupCloseButton = document.getElementById("close-button");
        const fileInput = document.getElementById('upload-input');
        const imageDisplay = document.getElementById('uploaded-image');
        const imageClearButton = document.getElementById('clear-image-button');
        const uploadButton = document.getElementById('upload-button');
        const postButton = document.getElementById('post-button');
        const form = document.getElementById("form");
        const caption = document.getElementById("caption");
        const fullname = document.getElementById("fullname");
        const fullnameInputSection = document.getElementById("full-name-input-section");
        const fullnameSaveIcon = document.getElementById("fullname-input-save");
        const fullnameInput = document.getElementById("fullname-input");

        fullname.addEventListener("click", function(){
            fullname.style.display = "none";
            fullnameInputSection.style.display = "flex";
            fullnameInput.focus();
        })
        fullnameSaveIcon.addEventListener("click", function(){
            fullname.style.display = "block";
            fullnameInputSection.style.display = "none";
        })
        postButton.addEventListener("click", function () {
            form.submit();
            {% comment %} if(imageDisplay.src){
                const data = {
                    'image_url':imageDisplay.src,
                    'caption':caption.value,
                }
                const options = {
                    method:'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body:JSON.stringify(data),
                }
                fetch('{% url 'posts:create-post' %}', options)
                .then(res=>console.log(res))
            } {% endcomment %}
            
        })
        createPostButton.addEventListener("click", function () {
            createPostPopup.style.display = "block";
        })
        popupCloseButton.addEventListener("click", function () {
            createPostPopup.style.display = "none";
        })
        imageClearButton.addEventListener("click", function () {
            imageDisplay.style.display = "none";
            imageClearButton.style.display = "none";
            uploadButton.style.display = 'block';
        })
        fileInput.addEventListener('change', (event) => {
        const selectedFile = event.target.files[0];

        if (selectedFile && selectedFile.type.startsWith('image/')) {
            const reader = new FileReader();

            reader.onload = function (e) {
            imageDisplay.src = e.target.result;
            imageDisplay.style.display = 'block';
            imageClearButton.style.display = 'block';
            uploadButton.style.display = 'none';
            };

            reader.readAsDataURL(selectedFile);
        } else {
            imageDisplay.style.display = 'none';
            imageClearButton.style.display = 'none';
            uploadButton.style.display = 'block';
        }
        });

    </script>
{% endblock main_content %}
